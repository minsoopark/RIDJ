<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.light_blue-blue.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="./stylesheets/index.css">
    <script src="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.2.js"></script>
    <script>
      function zeroPad(nr,base){
        var len = (String(base).length - String(nr).length)+1;
        return len > 0? new Array(len).join('0')+nr : nr;
      }
      $(function(){
        $('.ridi-search-button').on('click', function(){
          $(".ridi-songs-result").remove();
          
          var version = 1;
          var page = 1;
          var count = 10;
          var searchKeyword = $(".ridi-search-field").val();
          
          $.ajax({
            url: "http://apis.skplanetx.com/melon/songs?version=" + version + "&page=" + page + "&count=" + count + "&searchKeyword=" + searchKeyword,
            dataType: "json",
            headers: {
              "appKey": "9aefbb17-3d67-3069-a732-e03e4bb3b40c",
              "Accept-Language": "ko",
              "Accept": "application/json",
              "Content-Type": "application/xml; charset=utf-8"
            }
          }).done(function(data){
            var songs = data.melon.songs.song
            for (var i = 0; i < songs.length ; i++) {
              var songName = songs[i].songName;
              var artistName = songs[i].artists.artist[0].artistName;
              var albumName = songs[i].albumName;
              var playTime = songs[i].playTime;
              $(".ridi-songs-tbody").append(
                "<tr class='ridi-songs-result'>" +
                "<td class='mdl-data-table__cell--non-numeric' id='song-" + i + "'>" + songName +"</td>" +
                "<td class='mdl-data-table__cell--non-numeric' id='artist-" + i + "'>" + artistName +"</td>" +
                "<td class='mdl-data-table__cell--non-numeric' id='album-" + i + "'>" + albumName +"</td>" +
                "<td class='mdl-data-table__cell--non-numeric' id='play-time-" + i + "'>" + playTime +"</td>" +
                "<td class='mdl-data-table__cell--non-numeric'><button class='ridi-add-button mdl-button mdl-js-button mdl-button--icon mdl-button--accent' id='button-" + i + "'><i class='material-icons'>add</i></button></td>" +
                "</tr>"
              );
              $("#button-" + i).on('click', function(){
                var index = this.id.replace('button-', '');
                songName = $("#song-" + index).text();
                artistName = $("#artist-" + index).text();
                albumName = $("#album-" + index).text();
                playTime = $("#play-time-" + index).text();

                var requestData = "song=" + songName + "&artist=" + artistName + "&album=" + albumName + "&play_time=" + playTime;

                $.ajax({
                  url: "http://ridj.herokuapp.com/api/orders/new",
                  dataType: "json",
                  method: "POST",
                  data: requestData,
                }).done(function(data){
                  alert("곡이 신청되었습니다.");
                });
              });
            }
          });
        });
      });
    </script>
    <title>RIDI-J</title>
  </head>
  <body>
    <form class="ridi-search-form" action="#">
      <div class="mdl-textfield mdl-js-textfield">
        <input class="ridi-search-field mdl-textfield__input" type="text" id="song" />
        <label class="mdl-textfield__label" for="song">아티스트 혹은 곡 이름으로 검색..</label>
      </div>
      <button class="ridi-search-button mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-js-ripple-effect mdl-button--colored">
        <i class="material-icons">search</i>
      </button>
    </form>
    <table class="ridi-songs-table mdl-data-table mdl-js-data-table mdl-shadow--2dp">
      <thead>
        <tr>
          <th class="mdl-data-table__cell--non-numeric">곡</th>
          <th class="mdl-data-table__cell--non-numeric">아티스트</th>
          <th class="mdl-data-table__cell--non-numeric">앨범</th>
          <th class="mdl-data-table__cell--non-numeric">재생시간</th>
          <th class="mdl-data-table__cell--non-numeric">신청</th>
        </tr>
      </thead>
      <tbody class="ridi-songs-tbody">
      </tbody>
    </table>
  </body>
</html>
